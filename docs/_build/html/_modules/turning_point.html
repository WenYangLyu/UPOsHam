

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>turning_point &mdash; UPOsHam 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> UPOsHam
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc.html">Unstable Periodic Orbits in Hamiltonian systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc.html#id1">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc.html#id16">References</a></li>
</ul>
<p class="caption"><span class="caption-text">Methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../methods.html">Differential correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html#turning-point">Turning point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html#turning-point-based-on-configuration-difference">Turning point based on configuration difference</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">De Leon-Berne Hamiltonian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html#module-coupled_quartic_hamiltonian">Coupled quartic Hamiltonian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html#module-uncoupled_quartic_hamiltonian">Uncoupled quartic Hamiltonian</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing and reporting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to UPOsHam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id1">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id2">What should I know before I get started?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id3">How Can I Contribute?</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UPOsHam</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>turning_point</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for turning_point</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Sep 12 17:34:06 2019</span>

<span class="sd">@author: Wenyang Lyu and Shibabrat Naik</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">solve_ivp</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">fsolve</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;mathtext.fontset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cm&#39;</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;mathtext.rm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;serif&#39;</span>


<span class="c1">#%%</span>

<div class="viewcode-block" id="get_eq_pts"><a class="viewcode-back" href="../methods.html#turning_point.get_eq_pts">[docs]</a><span class="k">def</span> <span class="nf">get_eq_pts</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns configuration space coordinates of the equilibrium points.</span>

<span class="sd">    get_eq_pts(eqNum, init_guess_eqpt_model, grad_pot_model, par) solves the</span>
<span class="sd">    coordinates of the equilibrium point for a Hamiltonian of the form kinetic</span>
<span class="sd">    energy (KE) + potential energy (PE).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eqNum : int</span>
<span class="sd">        1 is the saddle-center equilibrium point</span>
<span class="sd">        2 or 3 is the center-center equilibrium point</span>

<span class="sd">    init_guess_eqpt_model : function name</span>
<span class="sd">        function that returns the initial guess for the equilibrium point</span>

<span class="sd">    grad_pot_model : function name</span>
<span class="sd">        function that defines the vector of potential gradient</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float (list)</span>
<span class="sd">        configuration space coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#fix the equilibrium point numbering convention here and make a</span>
    <span class="c1">#starting guess at the solution</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">init_guess_eqpt_model</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
    
    <span class="c1"># F(xEq) = 0 at the equilibrium point, solve using in-built function</span>
    <span class="n">F</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">grad_pot_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
    
    <span class="n">eqPt</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fprime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Call solver</span>
    
    <span class="k">return</span> <span class="n">eqPt</span></div>




<span class="c1">#%</span>
<div class="viewcode-block" id="get_total_energy"><a class="viewcode-back" href="../methods.html#turning_point.get_total_energy">[docs]</a><span class="k">def</span> <span class="nf">get_total_energy</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns total energy (value of Hamiltonian) of a phase space point on an orbit</span>

<span class="sd">    get_total_energy(orbit, pot_energy_model, parameters) returns the total energy for a</span>
<span class="sd">    Hamiltonian of the form KE + PE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orbit : float (list)</span>
<span class="sd">        phase space coordinates (x,y,px,py) of a point on an orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    parameters : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scalar</span>
<span class="sd">        total energy (value of Hamiltonian)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span>  <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span>  <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">px</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">py</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">pot_energy_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>   </div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_pot_surf_proj"><a class="viewcode-back" href="../methods.html#turning_point.get_pot_surf_proj">[docs]</a><span class="k">def</span> <span class="nf">get_pot_surf_proj</span><span class="p">(</span><span class="n">xVec</span><span class="p">,</span> <span class="n">yVec</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>            
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns projection of the potential energy (PE) surface on the configuration space</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xVec, yVec : 1d numpy arrays</span>
<span class="sd">        x,y-coordinates that discretizes the x, y domain of the configuration space</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    parameters : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    2d numpy array</span>
<span class="sd">        values of the PE</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xVec</span><span class="p">)</span>
    <span class="n">resY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xVec</span><span class="p">)</span>
    <span class="n">surfProj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xVec</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yVec</span><span class="p">)):</span>
            <span class="n">surfProj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_energy_model</span><span class="p">(</span><span class="n">xVec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">yVec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surfProj</span> </div>
    
    
<span class="c1">#%</span>
<div class="viewcode-block" id="state_transit_matrix"><a class="viewcode-back" href="../methods.html#turning_point.state_transit_matrix">[docs]</a><span class="k">def</span> <span class="nf">state_transit_matrix</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">,</span><span class="n">fixed_step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns state transition matrix, the trajectory, and the solution of the</span>
<span class="sd">    variational equations over a length of time</span>

<span class="sd">    In particular, for periodic solutions of % period tf=T, one can obtain</span>
<span class="sd">    the monodromy matrix, PHI(0,T).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tf : float</span>
<span class="sd">        final time for the integration</span>

<span class="sd">    x0 : float</span>
<span class="sd">        initial condition</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : 1d numpy array</span>
<span class="sd">        solution time</span>

<span class="sd">    x : 2d numpy array</span>
<span class="sd">        solution of the phase space coordinates</span>

<span class="sd">    phi_tf : 2d numpy array</span>
<span class="sd">        state transition matrix at the final time, tf</span>

<span class="sd">    PHI : 1d numpy array,</span>
<span class="sd">        solution of phase space coordinates and corresponding tangent space coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>  <span class="c1"># N=4 </span>
    <span class="n">RelTol</span><span class="o">=</span><span class="mf">3e-14</span>
    <span class="n">AbsTol</span><span class="o">=</span><span class="mf">1e-14</span>  
    <span class="n">tf</span> <span class="o">=</span> <span class="n">tf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fixed_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">TSPAN</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">tf</span> <span class="p">]</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">TSPAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">fixed_step</span><span class="p">)</span>
    <span class="n">PHI_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">PHI_0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">N</span><span class="p">),(</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#initial condition for state transition matrix</span>
    <span class="n">PHI_0</span><span class="p">[</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>                           <span class="c1"># initial condition for trajectory</span>

    
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">PHI</span><span class="p">:</span> <span class="n">variational_eqns_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">PHI</span><span class="p">,</span><span class="n">par</span><span class="p">)</span> <span class="c1"># Use partial in order to pass parameters to function</span>
    <span class="n">soln</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">PHI_0</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                     <span class="n">events</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">soln</span><span class="o">.</span><span class="n">t</span>
    <span class="n">PHI</span> <span class="o">=</span> <span class="n">soln</span><span class="o">.</span><span class="n">y</span>
    <span class="n">PHI</span> <span class="o">=</span> <span class="n">PHI</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">PHI</span><span class="p">[:,</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>		   <span class="c1"># trajectory from time 0 to tf</span>
    <span class="n">phi_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">PHI</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">],(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="c1"># state transition matrix, PHI(O,tf)</span>

    
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">phi_tf</span><span class="p">,</span><span class="n">PHI</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="dotproduct"><a class="viewcode-back" href="../methods.html#turning_point.dotproduct">[docs]</a><span class="k">def</span> <span class="nf">dotproduct</span><span class="p">(</span><span class="n">guess1</span><span class="p">,</span> <span class="n">guess2</span><span class="p">,</span><span class="n">n_turn</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> <span class="n">half_period_model</span><span class="p">,</span> \
                <span class="n">varEqns_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns x,y coordinates of the turning points for guess initial conditions guess1, guess2 and the defined product product for the 2 turning points</span>
<span class="sd">    </span>
<span class="sd">    Uses turning point method(defined a dot product form before the &quot;actual&quot; turning point.)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    guess1 : 1d numpy array </span>
<span class="sd">        guess initial condition 1 for the unstable periodic orbit</span>

<span class="sd">    guess2 : 1d numpy array </span>
<span class="sd">        guess initial condition 2 for the unstable periodic orbit</span>

<span class="sd">    n_turn : int</span>
<span class="sd">        nth turning point that is used to define the dot product</span>

<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>
<span class="sd">                    </span>
<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_turn1 : float</span>
<span class="sd">        x coordinate of the turning point with initional condition guess1</span>

<span class="sd">    x_turn2 : float</span>
<span class="sd">        x coordinate of the turning point with initional condition guess2</span>

<span class="sd">    y_turn1 : float</span>
<span class="sd">        y coordinate of the turning point with initional condition guess1</span>

<span class="sd">    y_turn2 : float</span>
<span class="sd">        y coordinate of the turning point with initional condition guess2</span>

<span class="sd">    dotproduct : float</span>
<span class="sd">        value of the dot product</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TSPAN</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="p">]</span>
    <span class="n">RelTol</span> <span class="o">=</span> <span class="mf">3.e-10</span>
    <span class="n">AbsTol</span> <span class="o">=</span> <span class="mf">1.e-10</span> 
    <span class="n">f1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">ham2dof_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">)</span> 
    <span class="n">soln1</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="n">guess1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                      <span class="n">events</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">half_period_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">),</span><span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>
    <span class="n">te1</span> <span class="o">=</span> <span class="n">soln1</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">te1</span><span class="p">[</span><span class="n">n_turn</span><span class="p">]]</span><span class="c1">#[0,te1[1]]</span>
    <span class="n">turn1</span> <span class="o">=</span> <span class="n">soln1</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">x_turn1</span> <span class="o">=</span> <span class="n">turn1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">y_turn1</span> <span class="o">=</span> <span class="n">turn1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">t</span><span class="p">,</span><span class="n">xx1</span><span class="p">,</span><span class="n">phi_t1</span><span class="p">,</span><span class="n">PHI</span> <span class="o">=</span> <span class="n">state_transit_matrix</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">guess1</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">p_perpendicular_1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:],</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:]))</span><span class="o">*</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:],</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:])</span><span class="o">*</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:]</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">ham2dof_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">)</span>  
    <span class="n">soln2</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="n">guess2</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span><span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                      <span class="n">events</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">half_period_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">),</span><span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>
    <span class="n">te2</span> <span class="o">=</span> <span class="n">soln2</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">te2</span><span class="p">[</span><span class="n">n_turn</span><span class="p">]]</span><span class="c1">#[0,te2[1]]</span>
    <span class="n">turn2</span> <span class="o">=</span> <span class="n">soln1</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">x_turn2</span> <span class="o">=</span> <span class="n">turn2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">y_turn2</span> <span class="o">=</span> <span class="n">turn2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">t</span><span class="p">,</span><span class="n">xx2</span><span class="p">,</span><span class="n">phi_t1</span><span class="p">,</span><span class="n">PHI</span> <span class="o">=</span> <span class="n">state_transit_matrix</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">guess2</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">xx2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">xx2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">xx2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">p_perpendicular_2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:],</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:]))</span><span class="o">*</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:],</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:])</span><span class="o">*</span><span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:]</span>
    <span class="n">dotproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_perpendicular_1</span><span class="p">,</span><span class="n">p_perpendicular_2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial guess1</span><span class="si">%s</span><span class="s2">, initial guess2</span><span class="si">%s</span><span class="s2">, dot product is</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">guess1</span><span class="p">,</span><span class="n">guess2</span><span class="p">,</span><span class="n">dotproduct</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">x_turn1</span><span class="p">,</span><span class="n">x_turn2</span><span class="p">,</span><span class="n">y_turn1</span><span class="p">,</span><span class="n">y_turn2</span><span class="p">,</span> <span class="n">dotproduct</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="turningPoint"><a class="viewcode-back" href="../methods.html#turning_point.turningPoint">[docs]</a><span class="k">def</span> <span class="nf">turningPoint</span><span class="p">(</span><span class="n">begin1</span><span class="p">,</span> <span class="n">begin2</span><span class="p">,</span> <span class="n">get_coord_model</span><span class="p">,</span> <span class="n">guess_coords_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                 <span class="n">half_period_model</span><span class="p">,</span> <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> \
                 <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n_turn</span><span class="p">,</span> <span class="n">show_itrsteps_plots</span><span class="p">,</span> <span class="n">po_fam_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    turningPoint computes the periodic orbit of target energy using turning point method.</span>
<span class="sd">    </span>
<span class="sd">    Given 2 inital conditions begin1, begin2, the periodic orbit is assumed to exist between begin1, begin2 such that</span>
<span class="sd">    trajectories with inital conditions begin1, begin2 are turning in different directions,</span>
<span class="sd">    which results in a negative value of the dot product</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    begin1 : function name</span>
<span class="sd">        guess initial condition 1 for the unstable periodic orbit</span>

<span class="sd">    begin2 : function name</span>
<span class="sd">        guess initial condition 2 for the unstable periodic orbit</span>

<span class="sd">    get_coord_model : function name</span>
<span class="sd">        function that returns the phase space coordinate for a given x/y value and total energy E</span>
<span class="sd">        </span>
<span class="sd">    guess_coord_model : function name</span>
<span class="sd">        function that returns the coordinates as guess for the next iteration of the </span>
<span class="sd">    turning point </span>
<span class="sd">        </span>
<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>

<span class="sd">    half_period_model : function name</span>
<span class="sd">        function that returns the event criteria in terms of the coordinate that is set to zero</span>
<span class="sd">        for half-period of the unstable periodic orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    plot_iter_orbit_model : function name</span>
<span class="sd">        function to plot the computed orbit in the 3D phase space of 2 position and 1 momentum</span>
<span class="sd">        coordinate</span>
<span class="sd">    </span>
<span class="sd">    par: float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    e: float </span>
<span class="sd">        total energy of the system</span>

<span class="sd">    n: int</span>
<span class="sd">        number of intervals that is divided bewteen the 2 initial guesses begin1 and begin2</span>
<span class="sd">        </span>
<span class="sd">    n_turn: int</span>
<span class="sd">        nth turning point that is used to define the dot product</span>
<span class="sd"> </span>
<span class="sd">    show_itrsteps_plots: logical</span>
<span class="sd">        flag (True or False) to show iteration of the UPOs in plots</span>

<span class="sd">    po_fam_file : function name</span>
<span class="sd">        file name to save the members in the family of the unstable periodic orbits      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0po : 1d numpy array </span>
<span class="sd">        Initial condition of the target unstable periodic orbit</span>
<span class="sd">        </span>
<span class="sd">    T : float</span>
<span class="sd">        Time period of the target unstable periodic orbit</span>
<span class="sd">        </span>
<span class="sd">    energyPO : float</span>
<span class="sd">        Energy of the target unstable periodic orbit. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">axis_fs</span> <span class="o">=</span> <span class="mi">15</span>
    
    <span class="n">guess1</span> <span class="o">=</span> <span class="n">begin1</span>
    <span class="n">guess2</span> <span class="o">=</span> <span class="n">begin2</span>
    <span class="n">MAXiter</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># record data for each iteration</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># record all data for every iteration</span>
    <span class="n">x0po</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">i_turn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">energyPO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAXiter</span> <span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iter_diff</span> <span class="o">=</span><span class="mi">0</span>  <span class="c1"># for counting the correct index</span>
    
    <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="n">MAXiter</span> <span class="ow">and</span> <span class="n">n_turn</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="n">xguess</span><span class="p">,</span> <span class="n">yguess</span> <span class="o">=</span> <span class="n">guess_coords_model</span><span class="p">(</span><span class="n">guess1</span><span class="p">,</span> <span class="n">guess2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">get_coord_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
            
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">xguess</span><span class="p">,</span><span class="n">yguess</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">x_turn1</span><span class="p">,</span><span class="n">x_turn2</span><span class="p">,</span><span class="n">y_turn1</span><span class="p">,</span><span class="n">y_turn2</span><span class="p">,</span> <span class="n">dotpro</span> <span class="o">=</span> <span class="n">dotproduct</span><span class="p">(</span><span class="n">guess1</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">n_turn</span><span class="p">,</span> \
                                                                 <span class="n">ham2dof_model</span><span class="p">,</span> \
                                                                 <span class="n">half_period_model</span><span class="p">,</span> \
                                                                 <span class="n">variational_eqns_model</span><span class="p">,</span> \
                                                                 <span class="n">par</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotpro</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">result2</span><span class="p">[(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">iter</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            
        <span class="n">i_turn_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#  we record the sign change for each pair of inital conditions</span>
            <span class="c1"># i_turn_iter is the coordinate which sign changes from positive to negative</span>
            <span class="c1"># we only want the first i_turn_iter terms to have positve sign and the rest of n-i_turn_iter+1 terms to have negative signs to avoid error</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">i_turn_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">result</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">check_same</span><span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_turn_iter</span><span class="p">])</span>
                <span class="n">check_diff</span><span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="n">i_turn_iter</span><span class="p">:])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">check_same</span> <span class="o">==</span> <span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">check_diff</span> <span class="o">==</span> <span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            

        <span class="k">if</span> <span class="n">check_same</span> <span class="o">==</span> <span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check_diff</span> <span class="o">==</span> <span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i_turn_iter</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if the follwing condition holds, we can zoom in to a smaller interval and continue our procedure</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">guesspo</span>  <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Our guess of the inital condition is&quot;</span><span class="p">,</span> <span class="n">guesspo</span><span class="p">)</span>
            <span class="n">x0po</span><span class="p">[</span><span class="nb">iter</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">guesspo</span><span class="p">[:]</span>
            <span class="n">TSPAN</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">RelTol</span> <span class="o">=</span> <span class="mf">3.e-10</span>
            <span class="n">AbsTol</span> <span class="o">=</span> <span class="mf">1.e-10</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">ham2dof_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">)</span> 
            <span class="n">soln</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="n">guesspo</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                             <span class="n">events</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">half_period_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">),</span><span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>
            <span class="n">te</span> <span class="o">=</span> <span class="n">soln</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">te</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">phi_t1</span><span class="p">,</span><span class="n">PHI</span> <span class="o">=</span> <span class="n">state_transit_matrix</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">guesspo</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">)</span>
            <span class="n">T</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;period is</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="n">T</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="c1">#print(len(t))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
                <span class="n">energy</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,:],</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
            <span class="n">energyPO</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">show_itrsteps_plots</span><span class="p">:</span> <span class="c1"># show iteration of the UPOs in plots</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
                <span class="n">plot_iter_orbit_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


            
            <span class="n">guess2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">guess1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iter_diff</span> <span class="o">=</span><span class="mi">0</span>
        <span class="c1"># If the if condition does not hold, it indicates that the interval we picked for performing &#39;dot product&#39; is wrong and it needs to be changed.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># return to the previous iteration that dot product works</span>
            <span class="c1">#iteration------i------i+1---------------i+2----------------i+3-----------------------i+4</span>
            <span class="c1">#            succ------succ-------------unsucc(return to i+1,n_turn+1)</span>
            <span class="c1">#                                              if  --------succ--------         </span>
            <span class="c1">#                                              else -----unsucc(return to i+1, n_turn+2)</span>
            <span class="c1">#                                       unscc---------------unsucc------------   unsucc(return to i, n_turn+3)        </span>
            <span class="c1">#</span>
            <span class="c1">#</span>
            <span class="c1">#</span>
            <span class="c1"># we take a larger interval so that it contains the true value of the initial condition and avoids to reach the limitation of the dot product</span>
            
            <span class="n">iter_diff</span> <span class="o">=</span> <span class="n">iter_diff</span> <span class="o">+</span><span class="mi">1</span>
            <span class="c1">#for k in range(iter):</span>
            <span class="k">if</span> <span class="n">iter_diff</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#iter_diff = iter_diff+1   # return to the iteration that is before the previous </span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: the result after this iteration may not be accurate, try to increase the number of intervals or use other ways &quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">n_turn</span> <span class="o">=</span> <span class="n">n_turn</span><span class="o">+</span><span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the nth turning point we pick is &quot;</span><span class="p">,</span> <span class="n">n_turn</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">iter</span><span class="o">-</span><span class="n">iter_diff</span><span class="p">)</span><span class="o">+</span><span class="n">i_turn</span><span class="p">[</span><span class="nb">iter</span><span class="o">-</span><span class="n">iter_diff</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index is &quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">xguess2</span><span class="o">=</span><span class="n">result2</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="n">iter_diff</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">yguess2</span> <span class="o">=</span><span class="n">result2</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="n">iter_diff</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">xguess1</span><span class="o">=</span><span class="n">result2</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">iter_diff</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">yguess1</span> <span class="o">=</span> <span class="n">result2</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">iter_diff</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">guess2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xguess2</span><span class="p">,</span> <span class="n">yguess2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">guess1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xguess1</span><span class="p">,</span> <span class="n">yguess1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    

        
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the nth turning point we pick is &quot;</span><span class="p">,</span> <span class="n">n_turn</span><span class="p">)</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">iter</span> <span class="o">+</span><span class="mi">1</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">MAXiter</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAXiter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">i</span>

    <span class="n">x0po</span> <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end</span><span class="p">,:]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">energyPO</span> <span class="o">=</span> <span class="n">energyPO</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>   
    
    <span class="n">dum</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0po</span><span class="p">,</span><span class="n">T</span><span class="p">,</span> <span class="n">energyPO</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">po_fam_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.16e</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0po</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">energyPO</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Wenyang Lyu, Shibabrat Naik, Stephen Wiggins

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>