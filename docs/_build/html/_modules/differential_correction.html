

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>differential_correction &mdash; UPOsHam 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> UPOsHam
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc.html">Unstable Periodic Orbits in Hamiltonian systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc.html#id1">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc.html#id16">References</a></li>
</ul>
<p class="caption"><span class="caption-text">Methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../methods.html">Differential correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html#turning-point">Turning point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html#turning-point-based-on-configuration-difference">Turning point based on configuration difference</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">De Leon-Berne Hamiltonian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html#module-coupled_quartic_hamiltonian">Coupled quartic Hamiltonian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html#module-uncoupled_quartic_hamiltonian">Uncoupled quartic Hamiltonian</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing and reporting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to UPOsHam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id1">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id2">What should I know before I get started?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html#id3">How Can I Contribute?</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UPOsHam</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>differential_correction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for differential_correction</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Sep 10 18:32:28 2019</span>

<span class="sd">@author: Wenyang Lyu and Shibabrat Naik</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">solve_ivp</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">fsolve</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;mathtext.fontset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cm&#39;</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;mathtext.rm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;serif&#39;</span>


<span class="c1">#%</span>
<div class="viewcode-block" id="get_eq_pts"><a class="viewcode-back" href="../methods.html#differential_correction.get_eq_pts">[docs]</a><span class="k">def</span> <span class="nf">get_eq_pts</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns configuration space coordinates of the equilibrium points.</span>

<span class="sd">    get_eq_pts(eqNum, init_guess_eqpt_model, grad_pot_model, par) solves the</span>
<span class="sd">    coordinates of the equilibrium point for a Hamiltonian of the form kinetic</span>
<span class="sd">    energy (KE) + potential energy (PE).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eqNum : int</span>
<span class="sd">        1 is the saddle-center equilibrium point</span>
<span class="sd">        2 or 3 is the center-center equilibrium point</span>

<span class="sd">    init_guess_eqpt_model : function name</span>
<span class="sd">        function that returns the initial guess for the equilibrium point</span>

<span class="sd">    grad_pot_model : function name</span>
<span class="sd">        function that defines the vector of potential gradient</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float (list)</span>
<span class="sd">        configuration space coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fix the equilibrium point numbering convention here and make a starting guess at the solution</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">init_guess_eqpt_model</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="c1"># F(xEq) = 0 at the equilibrium point, solve using in-built function</span>
    <span class="n">F</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">grad_pot_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">eqPt</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fprime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Call solver</span>

    <span class="k">return</span> <span class="n">eqPt</span></div>


<span class="c1">#%</span>
<div class="viewcode-block" id="get_total_energy"><a class="viewcode-back" href="../methods.html#differential_correction.get_total_energy">[docs]</a><span class="k">def</span> <span class="nf">get_total_energy</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns total energy (value of Hamiltonian) of a phase space point on an orbit</span>

<span class="sd">    get_total_energy(orbit, pot_energy_model, parameters) returns the total energy for a</span>
<span class="sd">    Hamiltonian of the form KE + PE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orbit : float (list)</span>
<span class="sd">        phase space coordinates (x,y,px,py) of a point on an orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    parameters : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scalar</span>
<span class="sd">        total energy (value of Hamiltonian)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span>  <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span>  <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>


    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">px</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">py</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">pot_energy_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_pot_surf_proj"><a class="viewcode-back" href="../methods.html#differential_correction.get_pot_surf_proj">[docs]</a><span class="k">def</span> <span class="nf">get_pot_surf_proj</span><span class="p">(</span><span class="n">xVec</span><span class="p">,</span> <span class="n">yVec</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns projection of the potential energy (PE) surface on the configuration space</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xVec, yVec : 1d numpy arrays</span>
<span class="sd">        x,y-coordinates that discretizes the x, y domain of the configuration space</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    parameters : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    2d numpy array</span>
<span class="sd">        values of the PE</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xVec</span><span class="p">)</span>
    <span class="n">resY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xVec</span><span class="p">)</span>
    <span class="n">surfProj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xVec</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yVec</span><span class="p">)):</span>
            <span class="n">surfProj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_energy_model</span><span class="p">(</span><span class="n">xVec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">yVec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surfProj</span></div>



<span class="c1">#%%</span>
<div class="viewcode-block" id="state_transit_matrix"><a class="viewcode-back" href="../methods.html#differential_correction.state_transit_matrix">[docs]</a><span class="k">def</span> <span class="nf">state_transit_matrix</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">,</span><span class="n">fixed_step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns state transition matrix, the trajectory, and the solution of the</span>
<span class="sd">    variational equations over a length of time</span>

<span class="sd">    In particular, for periodic solutions of % period tf=T, one can obtain</span>
<span class="sd">    the monodromy matrix, PHI(0,T).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tf : float</span>
<span class="sd">        final time for the integration</span>

<span class="sd">    x0 : float</span>
<span class="sd">        initial condition</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : 1d numpy array</span>
<span class="sd">        solution time</span>

<span class="sd">    x : 2d numpy array</span>
<span class="sd">        solution of the phase space coordinates</span>

<span class="sd">    phi_tf : 2d numpy array</span>
<span class="sd">        state transition matrix at the final time, tf</span>

<span class="sd">    PHI : 1d numpy array,</span>
<span class="sd">        solution of phase space coordinates and corresponding tangent space coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>  <span class="c1"># N=4</span>
    <span class="n">RelTol</span><span class="o">=</span><span class="mf">3e-14</span>
    <span class="n">AbsTol</span><span class="o">=</span><span class="mf">1e-14</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">tf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fixed_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">TSPAN</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">tf</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">TSPAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">fixed_step</span><span class="p">)</span>
    <span class="n">PHI_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">PHI_0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">N</span><span class="p">),(</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># initial condition for state transition matrix</span>
    <span class="n">PHI_0</span><span class="p">[</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>                    <span class="c1"># initial condition for trajectory</span>


    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">PHI</span><span class="p">:</span> <span class="n">variational_eqns_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">PHI</span><span class="p">,</span><span class="n">par</span><span class="p">)</span> <span class="c1"># Use partial in order to pass parameters to function</span>
    <span class="n">soln</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">PHI_0</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                     <span class="n">events</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">soln</span><span class="o">.</span><span class="n">t</span>
    <span class="n">PHI</span> <span class="o">=</span> <span class="n">soln</span><span class="o">.</span><span class="n">y</span>
    <span class="n">PHI</span> <span class="o">=</span> <span class="n">PHI</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">PHI</span><span class="p">[:,</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>		   <span class="c1"># trajectory from time 0 to tf</span>
    <span class="n">phi_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">PHI</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">],(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="c1"># state transition matrix, PHI(O,tf)</span>


    <span class="k">return</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">phi_tf</span><span class="p">,</span><span class="n">PHI</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="remove_infinitesimals"><a class="viewcode-back" href="../methods.html#differential_correction.remove_infinitesimals">[docs]</a><span class="k">def</span> <span class="nf">remove_infinitesimals</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1.e-14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns any complex matrix A with entries where the real or complex part has absolute</span>
<span class="sd">    value smaller than TOL set to 0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="clean_up_matrix"><a class="viewcode-back" href="../methods.html#differential_correction.clean_up_matrix">[docs]</a><span class="k">def</span> <span class="nf">clean_up_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns any complex matrix A with entries where the real or complex part has absolute</span>
<span class="sd">    value smaller than TOL set to 0, where TOL is set inside this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TOL</span><span class="o">=</span><span class="mf">1.e-14</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="p">:</span>
                <span class="n">a_kl</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">=</span> <span class="n">a_kl</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="p">:</span>
                <span class="n">a_kl</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
                <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_kl</span>

    <span class="k">return</span> <span class="n">A</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="eig_get"><a class="viewcode-back" href="../methods.html#differential_correction.eig_get">[docs]</a><span class="k">def</span> <span class="nf">eig_get</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">discrete</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the eigenvalues and eigenvectors of the matrix A spanning the three local subspaces</span>
<span class="sd">    &lt;Es,Eu,Ec&gt; where A is MxM and s+u+c=M, which locally approximate the invariant manifolds</span>
<span class="sd">    &lt;Ws,Wu,Wc&gt;</span>

<span class="sd">    This function is designed for continuous dynamical systems only.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : 2d numpy array</span>
<span class="sd">        Input matrix</span>

<span class="sd">    discrete : int</span>
<span class="sd">        flag to set if the dynamical system is discrete or continuous</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sn,un,cn,Ws,Wu,Wc : 1d numpy array</span>
<span class="sd">        eigenvalues and corresponding eigenvectors</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sn</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">un</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cn</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Ws</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Wu</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Wc</span><span class="o">=</span><span class="p">[]</span>

    <span class="c1"># arbitrary small displacement for use in discrete case</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.e-4</span>  <span class="c1"># &lt;== maybe needs tweeking?</span>
    <span class="n">M</span><span class="p">,</span><span class="n">dum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">D</span><span class="p">,</span><span class="n">V</span>  <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1"># obtain eigenvectors (V) and eigenvalues (D) of matrix A</span>
    <span class="n">D</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
    <span class="n">V</span>  <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">clean_up_matrix</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">clean_up_matrix</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">M</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">discrete</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>	         <span class="c1"># continuous time system</span>
            <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="n">jj</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">jj</span><span class="o">=</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">Ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ws</span><span class="p">,</span><span class="n">V</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="c1"># stable   (s dimensional)</span>
                <span class="n">Ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Ws</span><span class="p">,(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>
                <span class="n">Ws</span><span class="p">[:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_infinitesimals</span><span class="p">(</span><span class="n">Ws</span><span class="p">[:,</span><span class="n">s</span><span class="p">])</span>
                <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">un</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">un</span><span class="p">,</span><span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="n">jj</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">jj</span><span class="o">=</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">Wu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Wu</span><span class="p">,</span><span class="n">V</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="c1"># unstable (u dimensional)</span>
                <span class="n">Wu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Wu</span><span class="p">,(</span><span class="n">u</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>
                <span class="n">Wu</span><span class="p">[:,</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_infinitesimals</span><span class="p">(</span><span class="n">Wu</span><span class="p">[:,</span><span class="n">u</span><span class="p">])</span>
                <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="n">jj</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">jj</span><span class="o">=</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">Wc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Wc</span><span class="p">,</span><span class="n">V</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">V</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="c1"># center   (c dimensional)</span>
                <span class="n">Wc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Wc</span><span class="p">,(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>
                <span class="n">Wc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_infinitesimals</span><span class="p">(</span><span class="n">Wc</span><span class="p">[:,</span><span class="n">c</span><span class="p">])</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">Ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ws</span><span class="p">)</span>
    <span class="n">Wu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Wu</span><span class="p">)</span>
    <span class="n">Wc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Wc</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">sn</span><span class="p">,</span><span class="n">un</span><span class="p">,</span><span class="n">cn</span><span class="p">,</span><span class="n">Ws</span><span class="p">,</span><span class="n">Wu</span><span class="p">,</span><span class="n">Wc</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_po_guess_linear"><a class="viewcode-back" href="../methods.html#differential_correction.get_po_guess_linear">[docs]</a><span class="k">def</span> <span class="nf">get_po_guess_linear</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">Ax</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> <span class="n">jacobian_model</span><span class="p">,</span> \
                      <span class="n">guess_lin_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an initial guess for the differential correction method.</span>

<span class="sd">    Uses a small displacement from the equilibrium point (in a direction on the collinear point&#39;s</span>
<span class="sd">    center manifold) as a first guess for a planar periodic orbit (called a Lyapunov orbit). This</span>
<span class="sd">    initial condition and period are to be used as a first guess for the differential correction</span>
<span class="sd">    routine.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eqNum : int</span>
<span class="sd">        index of the equilibrium point (typically 1 or 2 or 3)</span>

<span class="sd">    Ax : float</span>
<span class="sd">        small nondimensional amplitude of the periodic orbit (&lt;&lt; 1)</span>

<span class="sd">    init_guess_eqpt_model : function name</span>
<span class="sd">        function that returns an initial guess to solve the equilibrium point using numerical</span>
<span class="sd">        solvers.</span>

<span class="sd">    grad_pot_model : function name</span>
<span class="sd">        function that returns gradient of the potential energy function.</span>

<span class="sd">    jacobian_model : function name</span>
<span class="sd">        function that returns Jacobian of the vector field.</span>

<span class="sd">    guess_lin_model : function name</span>
<span class="sd">        function that returns the initial guess based on linearization around the</span>
<span class="sd">        equilibrium point.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0poGuess : 1d numpy array</span>
<span class="sd">        guess initial condition for the periodic orbit (first guess)</span>

<span class="sd">    TGuess : float</span>
<span class="sd">        gues time period for the periodic orbit (first guess)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x0poGuess</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">eqPos</span> <span class="o">=</span> <span class="n">get_eq_pts</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
    <span class="n">eqPt</span> <span class="o">=</span> <span class="p">[</span><span class="n">eqPos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eqPos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># phase space location of equil. point</span>

    <span class="c1"># Get the eigenvalues and eigenvectors of Jacobian of ODEs at equil. point</span>

    <span class="k">def</span> <span class="nf">eq_pt_eig</span><span class="p">(</span><span class="n">eqPt</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all the eigenvectors locally spanning the 3 subspaces for the phase</span>
<span class="sd">        space in an infinitesimal region around an equilibrium point</span>

<span class="sd">        Our convention is to give the +y directed column eigenvectors</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eqPt : 1d numpy array</span>
<span class="sd">            equilibrium point in the phase space</span>

<span class="sd">        parameters : float (list)</span>
<span class="sd">            model parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Es,Eu,Ec,Vs,Vu,Vc :1d numpy array</span>
<span class="sd">            eigenvalues and eigenvectors</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">Df</span> <span class="o">=</span> <span class="n">jacobian_model</span><span class="p">(</span><span class="n">eqPt</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="n">Es</span><span class="p">,</span><span class="n">Eu</span><span class="p">,</span><span class="n">Ec</span><span class="p">,</span><span class="n">Vs</span><span class="p">,</span><span class="n">Vu</span><span class="p">,</span><span class="n">Vc</span> <span class="o">=</span> <span class="n">eig_get</span><span class="p">(</span><span class="n">Df</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>	<span class="c1"># find the eigenvectors</span>

        <span class="c1"># give the +y directed column vectors</span>
        <span class="k">if</span> <span class="n">Vs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Vs</span> <span class="o">=</span> <span class="o">-</span><span class="n">Vs</span>
        <span class="k">if</span> <span class="n">Vu</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Vu</span> <span class="o">=</span> <span class="o">-</span><span class="n">Vu</span>
        <span class="k">return</span> <span class="n">Es</span><span class="p">,</span><span class="n">Eu</span><span class="p">,</span><span class="n">Ec</span><span class="p">,</span><span class="n">Vs</span><span class="p">,</span><span class="n">Vu</span><span class="p">,</span><span class="n">Vc</span>

    <span class="p">[</span><span class="n">Es</span><span class="p">,</span><span class="n">Eu</span><span class="p">,</span><span class="n">Ec</span><span class="p">,</span><span class="n">Vs</span><span class="p">,</span><span class="n">Vu</span><span class="p">,</span><span class="n">Vc</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq_pt_eig</span><span class="p">(</span><span class="n">eqPt</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">L</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Ec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
    <span class="c1"># This is where the linearized guess based on center manifold needs</span>
    <span class="c1"># to be entered.</span>
    <span class="n">x0poGuess</span> <span class="o">=</span> <span class="n">guess_lin_model</span><span class="p">(</span><span class="n">eqPt</span><span class="p">,</span> <span class="n">Ax</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">TGuess</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">L</span>


    <span class="k">return</span> <span class="n">x0poGuess</span><span class="p">,</span><span class="n">TGuess</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_po_diffcorr"><a class="viewcode-back" href="../methods.html#differential_correction.get_po_diffcorr">[docs]</a><span class="k">def</span> <span class="nf">get_po_diffcorr</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> \
                   <span class="n">ham2dof_model</span><span class="p">,</span> <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">variational_eqns_model</span><span class="p">,</span> \
                   <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an initial condition and time period of an unstable periodic orbit using differential</span>
<span class="sd">    correction</span>

<span class="sd">    The initial condition is generated using a small (first-order derived using state transition</span>
<span class="sd">    matrix) correction of the initial guess where the assumption is the unstable periodic orbit</span>
<span class="sd">    projects as a function nameaight line on the configuration space.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x0 : float</span>
<span class="sd">        guess of the initial condition for the unstable periodic orbit</span>

<span class="sd">    diffcorr_setup_model : function name</span>
<span class="sd">        function that returns the combination of coordinates for applying terminal and periodic</span>
<span class="sd">        orbit conditions</span>

<span class="sd">    conv_coord_model : function name</span>
<span class="sd">        function that returns the coordinate for convergence criteria</span>

<span class="sd">    diffcorr_acc_corr_model : function name</span>
<span class="sd">        function that returns the corrected phase space coordinate and where the correction term</span>
<span class="sd">        is derived</span>

<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>

<span class="sd">    half_period_model : function name</span>
<span class="sd">        function that returns the event criteria in terms of the coordinate that is set to zero</span>
<span class="sd">        for half-period of the unstable periodic orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    plot_iter_orbit_model : function name</span>
<span class="sd">        function to plot the computed orbit in the 3D phase space of 2 position and 1 momentum</span>
<span class="sd">        coordinate</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0po : 1d numpy array</span>
<span class="sd">        initial condition for the periodic orbit</span>

<span class="sd">    t1 : float</span>
<span class="sd">        time period for the periodic orbit</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set show = 1 to plot successive approximations for debuggin/tinkering </span>
    <span class="n">show</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># (default=0)</span>
    <span class="c1"># axesFontName = &#39;factory&#39;</span>
    <span class="c1"># axesFontName = &#39;Times New Roman&#39;</span>
    <span class="c1"># label_fs = 20; axis_fs = 30; # fontsize for publications</span>



    <span class="c1"># tolerances for integration and perpendicular crossing of x-axis</span>
    <span class="c1"># MAXdxdot1 = 1.e-8; RelTol = 3.e-10; AbsTol = 1.e-10;</span>
    <span class="c1"># MAXdxdot1 = 1.e-12 ; RelTol = 3.e-14; AbsTol = 1.e-14;</span>
    <span class="n">RelTol</span> <span class="o">=</span> <span class="mf">3.e-14</span>
    <span class="n">AbsTol</span> <span class="o">=</span> <span class="mf">1.e-14</span>

    <span class="n">MAXattempt</span> <span class="o">=</span> <span class="mi">100</span>     	<span class="c1"># maximum number of attempts before error is declared</span>

    <span class="c1"># Using dydot or dxdot depends on which variable we want to keep fixed during differential correction.</span>
    <span class="c1"># dydot-----x fixed, dxdot------y fixed</span>
    <span class="n">drdot1</span><span class="p">,</span> <span class="n">correctr0</span><span class="p">,</span> <span class="n">MAXdrdot1</span> <span class="o">=</span> <span class="n">diffcorr_setup_model</span><span class="p">()</span>


    <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">drdot1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAXdrdot1</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="n">MAXattempt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum iterations exceeded&#39;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Find first half-period crossing event</span>
        <span class="n">TSPAN</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>        <span class="c1"># allow sufficient time for the half-period crossing event</span>

        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">ham2dof_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">)</span> <span class="c1"># Use partial in order to pass parameters to function</span>
        <span class="n">soln1</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">TSPAN</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK45&#39;</span><span class="p">,</span><span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                          <span class="n">events</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">half_period_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">par</span><span class="p">),</span> <span class="n">rtol</span><span class="o">=</span><span class="n">RelTol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">AbsTol</span><span class="p">)</span>

        <span class="n">te</span> <span class="o">=</span> <span class="n">soln1</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">te</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">xx1</span> <span class="o">=</span> <span class="n">soln1</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dxdot1</span> <span class="o">=</span> <span class="n">xx1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dydot1</span>  <span class="o">=</span> <span class="n">xx1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">drdot1</span> <span class="o">=</span> <span class="n">conv_coord_model</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">dxdot1</span><span class="p">,</span> <span class="n">dydot1</span><span class="p">)</span>

        <span class="c1"># Compute the state transition matrix from the initial state to the final state at the</span>
        <span class="c1"># half-period event</span>

        <span class="c1"># Events option not necessary anymore</span>
        <span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">phi_t1</span><span class="p">,</span><span class="n">PHI</span> <span class="o">=</span> <span class="n">state_transit_matrix</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">variational_eqns_model</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;::poDifCor : iteration&#39;</span><span class="p">,</span><span class="n">attempt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
            <span class="n">plot_iter_orbit_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">#=========================================================================</span>
        <span class="c1"># differential correction and convergence test, adjust according to</span>
        <span class="c1"># the particular problem</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="n">diffcorr_acc_corr_model</span><span class="p">(</span><span class="n">xx1</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">phi_t1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">attempt</span> <span class="o">=</span> <span class="n">attempt</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">x0po</span><span class="o">=</span><span class="n">x0</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x0po</span><span class="p">,</span><span class="n">t1</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_po_fam"><a class="viewcode-back" href="../methods.html#differential_correction.get_po_fam">[docs]</a><span class="k">def</span> <span class="nf">get_po_fam</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span><span class="n">Ax1</span><span class="p">,</span><span class="n">Ax2</span><span class="p">,</span><span class="n">nFam</span><span class="p">,</span><span class="n">po_fam_file</span><span class="p">,</span><span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> \
              <span class="n">jacobian_model</span><span class="p">,</span> <span class="n">guess_lin_model</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> \
              <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
              <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a family of unstable periodic orbits given two seed initial conditions and time periods</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eqNum : int</span>
<span class="sd">        1 is the saddle-center equilibrium point</span>
<span class="sd">        2 or 3 is the center-center equilibrium point </span>

<span class="sd">    Ax1, Ax2 : float</span>
<span class="sd">        amplitude of the guess periodic orbit (typically 1e-4 or 1e-5)</span>

<span class="sd">    nFam : int</span>
<span class="sd">        number of members in the family (monotonically increasing energy) of the unstable </span>
<span class="sd">        periodic orbits</span>

<span class="sd">    po_fam_file : function name</span>
<span class="sd">        file name to save the members in the family of the unstable periodic orbits</span>

<span class="sd">    init_guess_eqpt_model: function name</span>
<span class="sd">        function that returns the initial guess for the equilibrium point</span>
<span class="sd">    </span>
<span class="sd">    grad_pot_model : function name</span>
<span class="sd">        function that returns gradient of the potential energy function.</span>
<span class="sd">    </span>
<span class="sd">    jacobian_model : function name</span>
<span class="sd">        function that returns Jacobian of the vector field.</span>
<span class="sd">    </span>
<span class="sd">    guess_lin_model : function name</span>
<span class="sd">        function that returns the initial guess based on linearization around the</span>
<span class="sd">        equilibrium point.</span>
<span class="sd">    </span>
<span class="sd">    diffcorr_setup_model : function name</span>
<span class="sd">        function that returns the combination of coordinates for applying terminal and periodic</span>
<span class="sd">        orbit conditions</span>

<span class="sd">    conv_coord_model : function name</span>
<span class="sd">        function that returns the coordinate for convergence criteria</span>

<span class="sd">    diffcorr_acc_corr_model : function name</span>
<span class="sd">        function that returns the corrected phase space coordinate and where the correction term</span>
<span class="sd">        is derived</span>

<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>

<span class="sd">    half_period_model : function name</span>
<span class="sd">        function that returns the event criteria in terms of the coordinate that is set to zero</span>
<span class="sd">        for half-period of the unstable periodic orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    plot_iter_orbit_model : function name</span>
<span class="sd">        function to plot the computed orbit in the 3D phase space of 2 position and 1 momentum</span>
<span class="sd">        coordinate</span>


<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0po : 2d numpy array</span>
<span class="sd">        array of initial conditions for the members in the family of the unstable periodic orbits</span>
<span class="sd">        </span>
<span class="sd">    T : 1d numpy array</span>
<span class="sd">        column vector of time period for the members in the family of the unstable periodic orbits</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#guessed change in period between successive orbits in family</span>
    <span class="n">delt</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e-9</span>    <span class="c1"># &lt;==== may need to be changed</span>
    <span class="c1">#delt = -1.e-12</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># dimension of phase space</span>
    <span class="n">x0po</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFam</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="n">T</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFam</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">energyPO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFam</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">x0poGuess1</span><span class="p">,</span><span class="n">TGuess1</span> <span class="o">=</span> <span class="n">get_po_guess_linear</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">Ax1</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> \
                                           <span class="n">jacobian_model</span><span class="p">,</span> <span class="n">guess_lin_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
    <span class="n">x0poGuess2</span><span class="p">,</span><span class="n">TGuess2</span> <span class="o">=</span> <span class="n">get_po_guess_linear</span><span class="p">(</span><span class="n">eqNum</span><span class="p">,</span> <span class="n">Ax2</span><span class="p">,</span> <span class="n">init_guess_eqpt_model</span><span class="p">,</span> <span class="n">grad_pot_model</span><span class="p">,</span> \
                                           <span class="n">jacobian_model</span><span class="p">,</span> <span class="n">guess_lin_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="c1"># Get the first two periodic orbit initial conditions</span>
    <span class="n">iFam</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;::poFamGet : number&#39;</span><span class="p">,</span><span class="n">iFam</span><span class="p">)</span>
    <span class="n">x0po1</span><span class="p">,</span><span class="n">tfpo1</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">x0poGuess1</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> \
                                 <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                 <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                 <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po1</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>


    <span class="n">iFam</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;::poFamGet : number&#39;</span><span class="p">,</span><span class="n">iFam</span><span class="p">)</span>

    <span class="n">x0po2</span><span class="p">,</span><span class="n">tfpo2</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">x0poGuess2</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> \
                                 <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                 <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                 <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po2</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">x0po1</span><span class="p">[:]</span>
    <span class="n">x0po</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">x0po2</span><span class="p">[:]</span>
    <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo1</span>
    <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo2</span>
    <span class="c1">#Generate the other members of the family using numerical continuation</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">nFam</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;::poFamGet : number&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">dx</span>  <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span>  <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dt</span>  <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">t1po_g</span> <span class="o">=</span>   <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">delt</span>
        <span class="n">x0po_g</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

      <span class="c1"># differential correction takes place in the following function</span>
        <span class="n">x0po_i</span><span class="p">,</span><span class="n">tfpo_i</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">x0po_g</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> \
                                       <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                       <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                       <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>


        <span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0po_i</span>
        <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo_i</span>


        <span class="n">energyPO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iFam</span><span class="o">+</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="n">dum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0po</span><span class="p">,</span><span class="n">T</span><span class="p">,</span> <span class="n">energyPO</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">po_fam_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.16e</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">x0po</span><span class="p">,</span><span class="n">T</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="po_bracket_energy"><a class="viewcode-back" href="../methods.html#differential_correction.po_bracket_energy">[docs]</a><span class="k">def</span> <span class="nf">po_bracket_energy</span><span class="p">(</span><span class="n">energyTarget</span><span class="p">,</span> <span class="n">x0podata</span><span class="p">,</span> <span class="n">po_brac_file</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> \
                    <span class="n">conv_coord_model</span><span class="p">,</span> <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                    <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">variational_eqns_model</span><span class="p">,</span> \
                    <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns two unstable periodic orbits that bracket (bound in energy values) the unstable</span>
<span class="sd">    periodic orbit at the desired energy</span>

<span class="sd">    Generates a family of periodic orbits (po) given a pair of seed initial conditions from a </span>
<span class="sd">    data file, while targeting a specific periodic orbit. This is performed using a scaling </span>
<span class="sd">    factor of the numerical continuation step size which is used to obtain initial guess for </span>
<span class="sd">    the periodic orbit. The energy of target periodic orbit should be higher than the input </span>
<span class="sd">    periodic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energyTarget : float</span>
<span class="sd">        energy of the target unstable periodic orbit</span>
<span class="sd">    </span>
<span class="sd">    x0podata : 2d numpy array</span>
<span class="sd">        array of input members of the family of the unstable periodic orbit</span>
<span class="sd">    </span>
<span class="sd">    po_brac_file : str</span>
<span class="sd">        file name to save the 2 bounds of the target unstable periodic orbit</span>
<span class="sd">    </span>
<span class="sd">    diffcorr_setup_model : function name</span>
<span class="sd">        function that returns the combination of coordinates for applying terminal and periodic</span>
<span class="sd">        orbit conditions</span>

<span class="sd">    conv_coord_model : function name</span>
<span class="sd">        function that returns the coordinate for convergence criteria</span>

<span class="sd">    diffcorr_acc_corr_model : function name</span>
<span class="sd">        function that returns the corrected phase space coordinate and where the correction term</span>
<span class="sd">        is derived</span>

<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>

<span class="sd">    half_period_model : function name</span>
<span class="sd">        function that returns the event criteria in terms of the coordinate that is set to zero</span>
<span class="sd">        for half-period of the unstable periodic orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    plot_iter_orbit_model : function name</span>
<span class="sd">        function to plot the computed orbit in the 3D phase space of 2 position and 1 momentum</span>
<span class="sd">        coordinate</span>

<span class="sd">    par : float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0po : 2d numpy array</span>
<span class="sd">        2 bracketing unstable periodic orbits that bound the desired unstable periodic orbit</span>

<span class="sd">    T : 1d numpy array</span>
<span class="sd">        time period of the 2 bracketing unstable periodic orbits</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#energyTol = 1e-10 # decrease tolerance for higher target energy</span>
    <span class="n">energyTol</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># dimension of phase space</span>

    <span class="n">x0po</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="n">T</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">energyPO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>   <span class="o">=</span> <span class="n">x0podata</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">]</span>
    <span class="n">x0po</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>   <span class="o">=</span> <span class="n">x0podata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">]</span>
    <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>        <span class="o">=</span> <span class="n">x0podata</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="p">]</span>
    <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>        <span class="o">=</span> <span class="n">x0podata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">]</span>
    <span class="n">energyPO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">],</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
    <span class="n">energyPO</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">],</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

    <span class="n">iFam</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">scaleFactor</span> <span class="o">=</span> <span class="mf">1.25</span>   <span class="c1">#scaling the change in initial guess, usually in [1,2]</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">finished</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">iFam</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>


        <span class="c1">#change in initial guess for next step</span>
        <span class="n">dx</span>  <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span>  <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#check p.o. energy and set the initial guess with scale factor</span>
        <span class="k">if</span> <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">energyTarget</span><span class="p">:</span>
            <span class="n">scaleFactor</span> <span class="o">=</span> <span class="n">scaleFactor</span>
            <span class="n">x0po_g</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">scaleFactor</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">scaleFactor</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="p">[</span><span class="n">x0po_iFam</span><span class="p">,</span><span class="n">tfpo_iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">x0po_g</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> \
                                                    <span class="n">conv_coord_model</span><span class="p">,</span> \
                                                    <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                                    <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                                    <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> \
                                                    <span class="n">par</span><span class="p">)</span>

            <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po_iFam</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
            <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0po_iFam</span>
            <span class="n">T</span><span class="p">[</span><span class="n">iFam</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo_iFam</span>
            <span class="n">iFam</span> <span class="o">=</span> <span class="n">iFam</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1">#to improve speed of stepping, increase scale factor for very</span>
            <span class="c1">#close p.o., this is when target p.o. hasn&#39;t been crossed,</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                <span class="n">scaleFactor</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaleFactor</span> <span class="o">=</span> <span class="n">scaleFactor</span>

        <span class="k">elif</span> <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">energyTarget</span><span class="p">:</span>
            <span class="k">break</span>
            <span class="n">scaleFactor</span> <span class="o">=</span> <span class="n">scaleFactor</span><span class="o">*</span><span class="mf">1e-2</span>
            <span class="n">x0po_g</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">scaleFactor</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">scaleFactor</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="p">[</span><span class="n">x0po_iFam</span><span class="p">,</span><span class="n">tfpo_iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">x0po_g</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> \
                                                    <span class="n">conv_coord_model</span><span class="p">,</span> \
                                                    <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                                    <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                                    <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> \
                                                    <span class="n">par</span><span class="p">)</span>

            <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po_iFam</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
            <span class="n">x0po</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0po_iFam</span>
            <span class="n">T</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo_iFam</span>


        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">energyTarget</span> <span class="o">-</span> <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">energyTol</span><span class="o">*</span><span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Relative error in the po energy from target &#39;</span><span class="p">,</span> \
          <span class="nb">abs</span><span class="p">(</span><span class="n">energyTarget</span> <span class="o">-</span> <span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">energyPO</span><span class="p">[</span><span class="n">iFam</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0po</span><span class="p">,</span><span class="n">T</span><span class="p">,</span> <span class="n">energyPO</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">200</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
            <span class="n">Tend</span> <span class="o">=</span> <span class="n">i</span> <span class="c1"># Index of last row of the data, each row below this index is identically zero.</span>
    <span class="n">dum1</span> <span class="o">=</span> <span class="n">dum</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Tend</span><span class="p">,:]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">po_brac_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dum1</span> <span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.16e</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Tend</span><span class="p">,:],</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Tend</span><span class="p">]</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="po_target_energy"><a class="viewcode-back" href="../methods.html#differential_correction.po_target_energy">[docs]</a><span class="k">def</span> <span class="nf">po_target_energy</span><span class="p">(</span><span class="n">x0po</span><span class="p">,</span> <span class="n">energyTarget</span><span class="p">,</span> <span class="n">po_target_file</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> <span class="n">conv_coord_model</span><span class="p">,</span> \
                   <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                   <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    po_target_energy computes the periodic orbit of target energy using bisection method. </span>
<span class="sd">    </span>
<span class="sd">    Using bisection method on the lower and higher energy values of the POs to find the PO with </span>
<span class="sd">    the target energy. Use this condition to integrate with event function of half-period </span>
<span class="sd">    defined by maximum distance from the initial point on the PO</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x0po : 1d numpy array</span>
<span class="sd">        Initial conditions for the periodic orbit with the last two initial conditions </span>
<span class="sd">        bracketing (lower and higher than) the target energy</span>
<span class="sd">    </span>
<span class="sd">    diffcorr_setup_model : function name</span>
<span class="sd">        function that returns the combination of coordinates for applying terminal and periodic</span>
<span class="sd">        orbit conditions</span>

<span class="sd">    conv_coord_model : function name</span>
<span class="sd">        function that returns the coordinate for convergence criteria</span>

<span class="sd">    diffcorr_acc_corr_model : function name</span>
<span class="sd">        function that returns the corrected phase space coordinate and where the correction term</span>
<span class="sd">        is derived</span>

<span class="sd">    ham2dof_model : function name</span>
<span class="sd">        function that returns the Hamiltonian vector field at an input phase space coordinate</span>
<span class="sd">        and time</span>

<span class="sd">    half_period_model : function name</span>
<span class="sd">        function that returns the event criteria in terms of the coordinate that is set to zero</span>
<span class="sd">        for half-period of the unstable periodic orbit</span>

<span class="sd">    pot_energy_model : function name</span>
<span class="sd">        function that returns the potential energy of Hamiltonian</span>

<span class="sd">    variational_eqns_model : function name</span>
<span class="sd">        function that returns the variational equations of the dynamical system</span>

<span class="sd">    plot_iter_orbit_model : function name</span>
<span class="sd">        function to plot the computed orbit in the 3D phase space of 2 position and 1 momentum</span>
<span class="sd">        coordinate</span>
<span class="sd">    </span>
<span class="sd">    par: float (list)</span>
<span class="sd">        model parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0_PO : 1d numpy array </span>
<span class="sd">        Initial condition of the target unstable periodic orbit</span>
<span class="sd">        </span>
<span class="sd">    T_PO : float</span>
<span class="sd">        Time period of the target unstable periodic orbit</span>
<span class="sd">        </span>
<span class="sd">    ePO : float</span>
<span class="sd">        Energy of the target unstable periodic orbit.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#     label_fs = 10; axis_fs = 15; # small fontsize</span>
    <span class="n">label_fs</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">axis_fs</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># fontsize for publications</span>

    <span class="n">iFam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0po</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="n">energyTol</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">tpTol</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">show</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># for plotting the final PO</span>

    <span class="c1"># bisection method begins here</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iterMax</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">x0po</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bisection method begins </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
    <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="n">iterMax</span><span class="p">:</span>


        <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="c1"># guess based on midpoint</span>
        <span class="p">[</span><span class="n">x0po_iFam</span><span class="p">,</span><span class="n">tfpo_iFam</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_po_diffcorr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">diffcorr_setup_model</span><span class="p">,</span> \
                                                    <span class="n">conv_coord_model</span><span class="p">,</span> \
                                                    <span class="n">diffcorr_acc_corr_model</span><span class="p">,</span> <span class="n">ham2dof_model</span><span class="p">,</span> \
                                                    <span class="n">half_period_model</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> \
                                                    <span class="n">variational_eqns_model</span><span class="p">,</span> <span class="n">plot_iter_orbit_model</span><span class="p">,</span> \
                                                    <span class="n">par</span><span class="p">)</span>

        <span class="n">energyPO</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">x0po_iFam</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">x0po_iFam</span><span class="p">;</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">get_total_energy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">-</span> <span class="n">energyTarget</span><span class="p">)</span> <span class="o">&lt;</span> \
            <span class="n">energyTol</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">==</span> <span class="n">iterMax</span><span class="p">):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial condition: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">c</span><span class="p">);</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energy of the initial condition for PO </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">get_total_energy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> \
                                                                  <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">);</span>
            <span class="n">x0_PO</span> <span class="o">=</span> <span class="n">c</span>
            <span class="n">T_PO</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo_iFam</span><span class="p">;</span>
            <span class="n">ePO</span> <span class="o">=</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
            <span class="k">break</span>


        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">-</span> <span class="n">energyTarget</span> <span class="p">)</span> <span class="o">==</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sign</span> <span class="p">(</span> <span class="n">get_total_energy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">-</span> <span class="n">energyTarget</span> <span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bisection iteration number </span><span class="si">%s</span><span class="s1">, energy of PO: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">energyPO</span><span class="p">))</span> <span class="p">;</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bisection iterations completed: </span><span class="si">%s</span><span class="s1">, error in energy: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> \
                                                                <span class="nb">abs</span><span class="p">(</span><span class="n">get_total_energy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> \
                                                                <span class="n">pot_energy_model</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">-</span> \
                                                                <span class="n">energyTarget</span><span class="p">)));</span>


    <span class="n">dum</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">tfpo_iFam</span><span class="p">,</span> <span class="n">energyPO</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">po_target_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dum</span> <span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.16e</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x0_PO</span><span class="p">,</span> <span class="n">T_PO</span><span class="p">,</span> <span class="n">ePO</span></div>








</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Wenyang Lyu, Shibabrat Naik, Stephen Wiggins

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>